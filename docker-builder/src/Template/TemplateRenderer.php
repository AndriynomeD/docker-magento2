<?php

declare(strict_types=1);

namespace DockerBuilder\Core\Template;

use DockerBuilder\Core\Contract\TemplateRendererInterface;
use Exception;

/**
 * Template Renderer
 */
class TemplateRenderer implements TemplateRendererInterface
{
    /**
     * Render file contents based on variables
     * @param string $templatePath
     * @param array $variables
     * @return string
     */
    public function render(string $templatePath, array $variables): string
    {
        if ($variables['_enable_variables'] ?? false) {
            $content = $this->renderTemplate($templatePath, $variables);
        } else {
            $content = file_get_contents($templatePath);
            if ($content === false) {
                throw new Exception(sprintf("Failed to read template file %s", $templatePath));
            }
        }

        $content = str_replace('{{generated_by_builder}}',
            'This file is automatically generated. Do not edit directly.', $content);

        return $content;
    }

    /**
     * Render the given template file using the provided variables and return the resulting output.
     *
     * @param string $templateFile
     * @param array $variables
     * @return string
     */
    protected function renderTemplate(string $templateFile, array $variables): string
    {
        extract($variables, EXTR_OVERWRITE);
        ob_start();
        include $templateFile;
        $output = ob_get_clean();
        return $output ?: "";
    }

    /**
     * Return the first found template file name for the given file.
     * Example for 'Dockerfile':
     * [
     *      'Dockerfile-7.4-cli'
     *      'Dockerfile-7.4'
     *      'Dockerfile-cli' - found
     *      'Dockerfile'
     * ]
     *
     * @param string $filename
     * @param array $config
     * @return string|null
     */
    public function findTemplate(string $filename, array $config): ?string
    {
        $templateDirPath = $config['templateDirPath'];
        $potentialFilenames = [
            sprintf("%s-%s-%s", $filename, $config['version'], $config['flavour']),
            sprintf("%s-%s", $filename, $config['version']),
            sprintf("%s-%s", $filename, $config['flavour']),
            $filename,
        ];

        if ($config['templateSuffix']) {
            $potentialFilenames = [
                sprintf("%s-%s-%s-%s", $filename, $config['version'], $config['templateSuffix'], $config['flavour']),
                sprintf("%s-%s-%s", $filename, $config['version'], $config['templateSuffix']),
                sprintf("%s-%s-%s", $filename, $config['templateSuffix'], $config['flavour']),
                sprintf("%s-%s", $filename, $config['templateSuffix']),
                ...$potentialFilenames
            ];
        }

        foreach ($potentialFilenames as $potentialFilename) {
            $path = $templateDirPath . $potentialFilename;
            if (file_exists($path)) {
                if (!is_readable($path)) {
                    throw new Exception(sprintf('Template file %s not readable.', $path));
                }
                return $path;
            }
        }

        return null;
    }
}
